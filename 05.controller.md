# An Http Request Through Rails

### 05. Controller

当journey找到请求对应的route时，将会调用之前传入的`app`参数，这个参数其实并不一定是一个action，proc，任何rack程序，包括Sinatra在内都是有可能的。不过这里还是以解析action为主，毕竟再没有哪个Ruby的web框架有Rails这么功能强大的。

下面就是这个`app`的入口，这段代码并非Rails代码，而是Rails下一个子项目，journey的代码，定义在`journey-1.0.4/lib/journey/router.rb`中：

```ruby
def call env
  env['PATH_INFO'] = Utils.normalize_path env['PATH_INFO']

  find_routes(env).each do |match, parameters, route|
    script_name, path_info, set_params = env.values_at('SCRIPT_NAME',
                                                       'PATH_INFO',
                                                       @params_key)

    unless route.path.anchored
      env['SCRIPT_NAME'] = (script_name.to_s + match.to_s).chomp('/')
      env['PATH_INFO']   = Utils.normalize_path(match.post_match)
    end

    env[@params_key] = (set_params || {}).merge parameters

    status, headers, body = route.app.call(env)

    if 'pass' == headers['X-Cascade']
      env['SCRIPT_NAME'] = script_name
      env['PATH_INFO']   = path_info
      env[@params_key]   = set_params
      next
    end

    return [status, headers, body]
  end

  return [404, {'X-Cascade' => 'pass'}, ['Not Found']]
end
```
从代码里可以看见，事实上可以搜索多个匹配的routes进行处理，只要headers中`X-Cascade`为`pass`即可处理下一个搜索结果。

当`app`是一个`ActionDispatch::Routing::RouteSet::Dispatcher`实例时，call方法将进入下列代码，该代码定义在`actionpack-3.2.13/lib/action_dispatch/routing/route_set.rb`：

```ruby
def call(env)
  params = env[PARAMETERS_KEY]
  prepare_params!(params)

  # Just raise undefined constant errors if a controller was specified as default.
  unless controller = controller(params, @defaults.key?(:controller))
    return [404, {'X-Cascade' => 'pass'}, []]
  end

  dispatch(controller, params[:action], env)
end
```
可以看到，这里先取出了参数，然后送入了`prepare_params!`方法中：

```ruby
def prepare_params!(params)
  normalize_controller!(params)
  merge_default_action!(params)
  split_glob_param!(params) if @glob_param
end
```
可以明显看到代码分成了三个部分：

```ruby
def normalize_controller!(params)
  params[:controller] = params[:controller].underscore if params.key?(:controller)
end

def merge_default_action!(params)
  params[:action] ||= 'index'
end

def split_glob_param!(params)
  params[@glob_param] = params[@glob_param].split('/').map { |v| URI.parser.unescape(v) }
end
```
这三个方法定义都非常易懂，`normalize_controller!`对`:controller`项调用了`underscore`方法，`merge_default_action!`方法为`:action`参数增加了默认值`'index'`，